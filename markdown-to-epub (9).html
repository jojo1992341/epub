<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markdown ‚Üí EPUB</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=JetBrains+Mono:wght@300;400;500&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root {
      --bg: #0f0f13; --surface: #161620; --surface2: #1e1e2c; --border: #2a2a3d; --border2: #363650;
      --text: #d4cfbe; --text-dim: #8a8578; --text-bright: #f0ece0; --gold: #c9a84c; --gold-dim: #8a6e2a;
      --gold-bright: #e8c46a; --editor-bg: #0b0b0f; --editor-text: #d4cfbe; --preview-bg: #faf7f0; --preview-text: #2c2820;
      --ok: #5dba7e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { height: 100vh; display: flex; flex-direction: column; background: var(--bg); color: var(--text); font-family: 'Crimson Pro', Georgia, serif; overflow: hidden; }
    header { height: 52px; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 1.25rem; background: var(--surface); border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 0.6rem; }
    .logo-icon { width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%); color: #111; font-size: 14px; }
    .logo-text { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 600; color: var(--text-bright); }
    .header-actions { display: flex; align-items: center; gap: 0.6rem; }
    .btn { border: 1px solid var(--border2); background: transparent; color: var(--text); border-radius: 3px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.04em; padding: 0.4rem 0.85rem; transition: .15s; }
    .btn:hover { border-color: var(--gold-dim); color: var(--gold-bright); }
    .btn-primary { color: #0f0f13; border-color: var(--gold); background: linear-gradient(135deg, var(--gold) 0%, #a87c2a 100%); font-weight: 600; }
    .toolbar { flex-shrink: 0; display: flex; align-items: center; gap: .75rem; padding: .5rem 1.25rem; background: var(--surface2); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .field-group { display: flex; align-items: center; gap: .4rem; }
    .field-label { font-family: 'JetBrains Mono', monospace; color: var(--text-dim); font-size: 0.64rem; text-transform: uppercase; letter-spacing: .1em; }
    input[type="text"], select { height: 30px; border: 1px solid var(--border2); border-radius: 3px; outline: none; background: var(--editor-bg); color: var(--text-bright); padding: 0 .55rem; font-family: 'Crimson Pro', serif; font-size: .92rem; }
    #input-title { width: 180px; } #input-author { width: 130px; }
    .toolbar-sep { width: 1px; height: 22px; background: var(--border2); }
    .main { flex: 1; min-height: 0; display: flex; overflow: hidden; }
    .pane { flex: 1; min-width: 0; min-height: 0; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .pane-header { flex-shrink: 0; height: 32px; display: flex; align-items: center; justify-content: space-between; padding: 0 .95rem; background: var(--surface2); border-bottom: 1px solid var(--border); }
    .pane-title { font-family: 'JetBrains Mono', monospace; color: var(--text-dim); font-size: 0.65rem; letter-spacing: .1em; text-transform: uppercase; }
    .editor-wrapper { flex: 1; min-height: 0; position: relative; overflow: hidden; background: var(--editor-bg); }
    .line-numbers { position: absolute; left: 0; top: 0; bottom: 0; width: 3.2rem; border-right: 1px solid var(--border); color: var(--border2); font-family: 'JetBrains Mono', monospace; font-size: .85rem; line-height: 1.75; pointer-events: none; overflow: hidden; padding: 1.5rem .35rem 1.5rem 0; text-align: right; user-select: none; }
    #line-numbers-content { white-space: pre; transform: translateY(0); will-change: transform; }
    #editor { width: 100%; height: 100%; border: none; outline: none; resize: none; padding: 1.5rem 1.5rem 1.5rem 4rem; background: var(--editor-bg); color: var(--editor-text); font-family: 'JetBrains Mono', monospace; font-size: .85rem; line-height: 1.75; white-space: pre; overflow: auto; }
    .pane-divider { width: 4px; background: var(--border); cursor: col-resize; flex-shrink: 0; }
    #preview { flex: 1; min-height: 0; overflow: auto; padding: 2rem 2.4rem; background: var(--preview-bg); color: var(--preview-text); font-size: 1.08rem; line-height: 1.75; }
    #preview h1, #preview h2, #preview h3, #preview h4 { font-family: 'Playfair Display', serif; margin: 1rem 0 .5rem; }
    #preview h1 { font-size: 1.8rem; border-bottom: 2px solid #c9a84c; padding-bottom: .25rem; }
    #preview h4 { border-left: 3px solid #c9a84c; padding-left: .65rem; }
    #preview p { margin: .65rem 0; }
    #preview blockquote { border-left: 3px solid #c9a84c; margin: .9rem 0 .9rem 1rem; padding-left: 1rem; color: #5a4e3c; }
    #preview code { font-family: 'JetBrains Mono', monospace; font-size: .86em; background: #ede9df; padding: .1em .3em; border-radius: 2px; }
    #preview pre { background: #ede9df; padding: .85rem 1rem; border-left: 3px solid #c9a84c; overflow: auto; }
    .chapter-divider { height: 1px; background: #c9a84c44; margin: 1.6rem 0; }
    footer { height: 28px; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 1.25rem; border-top: 1px solid var(--border); background: var(--surface); color: var(--text-dim); font-family: 'JetBrains Mono', monospace; font-size: .68rem; }
    .status-row { display: flex; align-items: center; gap: 1rem; }
    .status-ok { color: var(--ok); }
    #file-input { display: none; }
    #toast { position: fixed; right: 1rem; bottom: 2.3rem; background: var(--surface2); border: 1px solid var(--border2); border-left: 3px solid var(--gold); padding: .55rem .8rem; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: .72rem; opacity: 0; transform: translateY(6px); transition: .2s; pointer-events: none; z-index: 1000; }
    #toast.show { opacity: 1; transform: translateY(0); }
    @media (max-width: 900px) { .main { flex-direction: column; } .pane-divider { display: none; } #input-title { width: 140px; } #input-author { width: 110px; } }
  </style>
</head>
<body>
  <header>
    <div class="logo"><div class="logo-icon">üìñ</div><div class="logo-text">Markdown ‚Üí EPUB</div></div>
    <div class="header-actions">
      <button class="btn" id="btn-theme">‚óê</button>
      <button class="btn" id="btn-export-md">‚¨° MD</button>
      <button class="btn" id="btn-export-html">‚¨° HTML</button>
      <button class="btn btn-primary" id="btn-export-epub">üì• Export EPUB</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="field-group"><span class="field-label">Titre</span><input type="text" id="input-title" placeholder="Mon livre‚Ä¶" /></div>
    <div class="field-group"><span class="field-label">Auteur</span><input type="text" id="input-author" placeholder="Anonyme" /></div>
    <div class="field-group"><span class="field-label">Lang</span><select id="input-lang"><option value="fr">üá´üá∑ FR</option><option value="en">üá¨üáß EN</option><option value="es">üá™üá∏ ES</option></select></div>
    <div class="toolbar-sep"></div>
    <button class="btn" id="btn-import">üìÇ Importer</button>
    <input id="file-input" type="file" accept=".md,.txt" />
    <button class="btn" id="btn-clear">üóë Nettoyer</button>
    <div class="toolbar-sep"></div>
    <button class="btn" id="btn-font-down">A‚àí</button>
    <button class="btn" id="btn-font-up">A+</button>
  </div>

  <div class="main">
    <section class="pane" id="pane-editor">
      <div class="pane-header"><span class="pane-title">‚ú¶ √âditeur Markdown</span><span class="pane-title" id="chapter-badge" style="font-size:.58rem"></span></div>
      <div class="editor-wrapper">
        <div class="line-numbers"><div id="line-numbers-content"></div></div>
        <textarea id="editor" spellcheck="false"># Mon Livre

#### Chapitre 1 ‚Äî Le d√©but

Votre texte Markdown ici.

#### Chapitre 2 ‚Äî La suite

Continuez votre histoire...</textarea>
      </div>
    </section>

    <div class="pane-divider" id="divider"></div>

    <section class="pane" id="pane-preview">
      <div class="pane-header"><span class="pane-title">‚óà Pr√©visualisation</span><span class="pane-title" style="font-size:.58rem">Synchronis√©e</span></div>
      <article id="preview"></article>
    </section>
  </div>

  <footer>
    <div class="status-row">
      <span>Chapitres <strong id="stat-chapters">0</strong></span>
      <span>Mots <strong id="stat-words">0</strong></span>
      <span>Taille <strong id="stat-size">0 KB</strong></span>
      <span>Lignes <strong id="stat-lines">0</strong></span>
    </div>
    <div class="status-row status-ok"><span id="status-save">‚óè Sauvegard√©</span></div>
  </footer>

  <div id="toast"></div>

  <script>
    marked.setOptions({ gfm: true, breaks: false });

    const $ = id => document.getElementById(id);
    const editor = $('editor');
    const preview = $('preview');
    const lineNumbers = $('line-numbers-content');

    let fontSize = 13.6;
    let syncLock = false;
    let saveTimer;
    let dark = true;

    function toast(msg) {
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => t.classList.remove('show'), 1900);
    }

    function escapeXML(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function splitIntoChapters(md) {
      const regex = /^####\s+(.+)$/gm;
      const matches = [...md.matchAll(regex)];
      if (!matches.length) return [{ id: 'chapter-1', title: 'Chapitre 1', content: md || '' }];
      const chapters = [];
      const first = matches[0].index;
      if (first > 0) {
        const intro = md.slice(0, first).trim();
        if (intro) chapters.push({ id: 'intro', title: 'Introduction', content: intro });
      }
      matches.forEach((m, i) => {
        const start = m.index;
        const end = (i + 1 < matches.length) ? matches[i + 1].index : md.length;
        chapters.push({ id: `chapter-${i + 1}`, title: m[1].trim() || 'Chapitre', content: md.slice(start, end) });
      });
      return chapters;
    }

    function renderWithSourceMap(md) {
      const tokens = marked.lexer(md);
      const startLines = [];
      let line = 0;
      tokens.forEach(t => {
        startLines.push(line);
        if (t.raw) line += t.raw.split('\n').length - 1;
      });

      const renderer = new marked.Renderer();
      let idx = 0;
      const src = () => startLines[idx++] ?? 0;

      renderer.heading = (text, level) => `<h${level} data-srcline="${src()}">${text}</h${level}>\n`;
      renderer.paragraph = (text) => `<p data-srcline="${src()}">${text}</p>\n`;
      renderer.blockquote = (q) => `<blockquote data-srcline="${src()}">${q}</blockquote>\n`;
      renderer.list = (body, ordered, start) => {
        const tag = ordered ? 'ol' : 'ul';
        const s = ordered && start !== 1 ? ` start="${start}"` : '';
        return `<${tag} data-srcline="${src()}"${s}>${body}</${tag}>\n`;
      };
      renderer.code = (code, lang) => {
        const ln = src();
        const escaped = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const cls = lang ? ` class="language-${lang}"` : '';
        return `<pre data-srcline="${ln}"><code${cls}>${escaped}</code></pre>\n`;
      };
      renderer.hr = () => `<hr data-srcline="${src()}"/>\n`;

      return marked.parse(md, { renderer });
    }

    function updateLineNumbers() {
      const count = editor.value.split('\n').length;
      lineNumbers.textContent = Array.from({ length: count }, (_, i) => i + 1).join('\n');
      lineNumbers.style.transform = `translateY(${-editor.scrollTop}px)`;
    }

    function indexToLine(index) {
      return editor.value.slice(0, index).split('\n').length - 1;
    }

    function lineToIndex(lineNumber) {
      const lines = editor.value.split('\n');
      const clamped = Math.max(0, Math.min(lineNumber, lines.length - 1));
      let idx = 0;
      for (let i = 0; i < clamped; i++) idx += lines[i].length + 1;
      return idx;
    }

    function syncEditorToPreview() {
      if (syncLock) return;
      const curLine = indexToLine(editor.selectionStart);
      const markers = [...preview.querySelectorAll('[data-srcline]')];
      if (!markers.length) return;

      let best = markers[0];
      for (const m of markers) {
        const l = Number(m.dataset.srcline || 0);
        if (l <= curLine) best = m;
        else break;
      }
      syncLock = true;
      const pRect = preview.getBoundingClientRect();
      const eRect = best.getBoundingClientRect();
      preview.scrollTop += (eRect.top - pRect.top) - 6;
      requestAnimationFrame(() => { syncLock = false; });
    }

    function syncPreviewToEditorFromClick(target) {
      if (syncLock) return;
      const marker = target.closest('[data-srcline]');
      if (!marker) return;
      const line = Number(marker.dataset.srcline || 0);
      const idx = lineToIndex(line);
      syncLock = true;
      editor.focus();
      editor.setSelectionRange(idx, idx);
      const lineHeight = parseFloat(getComputedStyle(editor).lineHeight) || 24;
      const paddingTop = parseFloat(getComputedStyle(editor).paddingTop) || 24;
      editor.scrollTop = Math.max(0, line * lineHeight - paddingTop);
      updateLineNumbers();
      requestAnimationFrame(() => { syncLock = false; syncEditorToPreview(); });
    }

    function updateStats(md, chapters) {
      const words = md.trim() ? md.trim().split(/\s+/).length : 0;
      const sizeKB = (new Blob([md]).size / 1024).toFixed(1);
      $('stat-chapters').textContent = chapters.length;
      $('stat-words').textContent = words.toLocaleString('fr-FR');
      $('stat-size').textContent = `${sizeKB} KB`;
      $('stat-lines').textContent = md.split('\n').length.toLocaleString('fr-FR');
      $('chapter-badge').textContent = `${chapters.length} chapitre${chapters.length > 1 ? 's' : ''}`;
    }

    function saveLocal(md) {
      clearTimeout(saveTimer);
      $('status-save').textContent = '‚óè Sauvegarde...';
      saveTimer = setTimeout(() => {
        localStorage.setItem('md2epub_content', md);
        localStorage.setItem('md2epub_title', $('input-title').value);
        localStorage.setItem('md2epub_author', $('input-author').value);
        localStorage.setItem('md2epub_lang', $('input-lang').value);
        $('status-save').textContent = '‚óè Sauvegard√©';
      }, 450);
    }

    function updatePreview() {
      const md = editor.value;
      const chapters = splitIntoChapters(md);
      const html = renderWithSourceMap(md);
      preview.innerHTML = html || '<p style="opacity:.6;font-style:italic">Commencez √† √©crire‚Ä¶</p>';
      updateStats(md, chapters);
      saveLocal(md);
    }

    function downloadBlob(name, blob) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    function exportMarkdown() {
      const md = editor.value;
      if (!md.trim()) return toast('√âditeur vide');
      const title = ($('input-title').value.trim() || 'livre').replace(/[^\w\s-]/g, '').trim() || 'livre';
      downloadBlob(`${title}.md`, new Blob([md], { type: 'text/markdown;charset=utf-8' }));
      toast('Markdown export√©');
    }

    function exportHTML() {
      const md = editor.value;
      if (!md.trim()) return toast('√âditeur vide');
      const title = $('input-title').value.trim() || 'Mon livre';
      const author = $('input-author').value.trim() || 'Anonyme';
      const lang = $('input-lang').value;
      const chapters = splitIntoChapters(md);
      const toc = chapters.map(c => `<li>${escapeXML(c.title)}</li>`).join('');
      const body = marked.parse(md);
      const html = `<!doctype html><html lang="${lang}"><head><meta charset="utf-8"><title>${escapeXML(title)}</title><style>body{max-width:760px;margin:2rem auto;padding:0 1rem;line-height:1.7;font-family:Georgia,serif}h1,h2,h3,h4{font-family:serif}nav{padding:1rem;border:1px solid #ddd;background:#fafafa}</style></head><body><h1>${escapeXML(title)}</h1><p><em>${escapeXML(author)}</em></p><nav><strong>Table des mati√®res</strong><ol>${toc}</ol></nav>${body}</body></html>`;
      downloadBlob(`${title.replace(/[^\w\s-]/g, '').trim() || 'livre'}.html`, new Blob([html], { type: 'text/html;charset=utf-8' }));
      toast('HTML export√©');
    }

    async function exportEPUB() {
      const md = editor.value;
      if (!md.trim()) return toast('√âditeur vide');
      const meta = {
        title: $('input-title').value.trim() || 'Mon livre',
        author: $('input-author').value.trim() || 'Anonyme',
        lang: $('input-lang').value
      };
      const chapters = splitIntoChapters(md);
      const zip = new JSZip();
      const uuid = generateUUID();

      zip.file('mimetype', 'application/epub+zip', { compression: 'STORE' });
      zip.file('META-INF/container.xml', `<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);

      const manifestItems = chapters.map(c => `<item id="${c.id}" href="${c.id}.xhtml" media-type="application/xhtml+xml"/>`).join('');
      const spine = chapters.map(c => `<itemref idref="${c.id}"/>`).join('');
      zip.file('OEBPS/content.opf', `<?xml version="1.0" encoding="UTF-8"?><package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="book-id"><metadata xmlns:dc="http://purl.org/dc/elements/1.1/"><dc:identifier id="book-id">urn:uuid:${uuid}</dc:identifier><dc:title>${escapeXML(meta.title)}</dc:title><dc:creator>${escapeXML(meta.author)}</dc:creator><dc:language>${meta.lang}</dc:language></metadata><manifest><item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/><item id="css" href="style.css" media-type="text/css"/>${manifestItems}</manifest><spine toc="ncx">${spine}</spine></package>`);
      zip.file('OEBPS/toc.ncx', `<?xml version="1.0" encoding="UTF-8"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><head><meta name="dtb:uid" content="urn:uuid:${uuid}"/></head><docTitle><text>${escapeXML(meta.title)}</text></docTitle><navMap>${chapters.map((c,i)=>`<navPoint id="np-${i+1}" playOrder="${i+1}"><navLabel><text>${escapeXML(c.title)}</text></navLabel><content src="${c.id}.xhtml"/></navPoint>`).join('')}</navMap></ncx>`);
      zip.file('OEBPS/style.css', 'body{font-family:Georgia,serif;line-height:1.7;margin:1.5em;color:#222}h1,h2,h3,h4{font-family:serif}');

      chapters.forEach(c => {
        const body = marked.parse(c.content);
        zip.file(`OEBPS/${c.id}.xhtml`, `<?xml version="1.0" encoding="UTF-8"?><html xmlns="http://www.w3.org/1999/xhtml"><head><title>${escapeXML(c.title)}</title><link rel="stylesheet" href="style.css"/></head><body>${body}</body></html>`);
      });

      const blob = await zip.generateAsync({ type: 'blob', mimeType: 'application/epub+zip', compression: 'DEFLATE' });
      downloadBlob(`${meta.title.replace(/[^\w\s-]/g, '').trim() || 'livre'}.epub`, blob);
      toast('EPUB g√©n√©r√©');
    }

    function restore() {
      const saved = localStorage.getItem('md2epub_content');
      if (saved) editor.value = saved;
      $('input-title').value = localStorage.getItem('md2epub_title') || '';
      $('input-author').value = localStorage.getItem('md2epub_author') || '';
      $('input-lang').value = localStorage.getItem('md2epub_lang') || 'fr';
    }

    editor.addEventListener('input', () => { updateLineNumbers(); updatePreview(); });
    editor.addEventListener('scroll', updateLineNumbers);
    editor.addEventListener('click', syncEditorToPreview);
    editor.addEventListener('keyup', syncEditorToPreview);
    preview.addEventListener('click', e => syncPreviewToEditorFromClick(e.target));

    $('btn-export-md').addEventListener('click', exportMarkdown);
    $('btn-export-html').addEventListener('click', exportHTML);
    $('btn-export-epub').addEventListener('click', exportEPUB);

    $('btn-import').addEventListener('click', () => $('file-input').click());
    $('file-input').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        editor.value = ev.target.result;
        updateLineNumbers();
        updatePreview();
        toast(`Import√©: ${file.name}`);
        e.target.value = '';
      };
      reader.readAsText(file);
    });

    $('btn-clear').addEventListener('click', () => {
      if (!editor.value.trim() || confirm('Effacer tout le contenu ?')) {
        editor.value = '';
        updateLineNumbers();
        updatePreview();
      }
    });

    $('btn-font-up').addEventListener('click', () => {
      fontSize = Math.min(fontSize + 1, 22);
      editor.style.fontSize = `${fontSize}px`;
      lineNumbers.style.fontSize = `${fontSize}px`;
      updateLineNumbers();
    });

    $('btn-font-down').addEventListener('click', () => {
      fontSize = Math.max(fontSize - 1, 9);
      editor.style.fontSize = `${fontSize}px`;
      lineNumbers.style.fontSize = `${fontSize}px`;
      updateLineNumbers();
    });

    $('btn-theme').addEventListener('click', () => {
      dark = !dark;
      const root = document.documentElement;
      if (dark) {
        root.style.setProperty('--bg', '#0f0f13'); root.style.setProperty('--surface', '#161620'); root.style.setProperty('--surface2', '#1e1e2c');
        root.style.setProperty('--border', '#2a2a3d'); root.style.setProperty('--border2', '#363650'); root.style.setProperty('--text', '#d4cfbe');
        root.style.setProperty('--text-dim', '#8a8578'); root.style.setProperty('--text-bright', '#f0ece0'); root.style.setProperty('--editor-bg', '#0b0b0f'); root.style.setProperty('--editor-text', '#d4cfbe');
      } else {
        root.style.setProperty('--bg', '#f5f1e8'); root.style.setProperty('--surface', '#ede8dc'); root.style.setProperty('--surface2', '#e5dfd0');
        root.style.setProperty('--border', '#c8bfaa'); root.style.setProperty('--border2', '#b8ae98'); root.style.setProperty('--text', '#3c3428');
        root.style.setProperty('--text-dim', '#7a6e5c'); root.style.setProperty('--text-bright', '#1a1410'); root.style.setProperty('--editor-bg', '#faf7f0'); root.style.setProperty('--editor-text', '#2c2820');
      }
    });

    const divider = $('divider');
    let resizing = false;
    divider.addEventListener('mousedown', () => { resizing = true; document.body.style.userSelect = 'none'; document.body.style.cursor = 'col-resize'; });
    document.addEventListener('mousemove', e => {
      if (!resizing) return;
      const main = document.querySelector('.main');
      const rect = main.getBoundingClientRect();
      const pct = ((e.clientX - rect.left) / rect.width) * 100;
      const clamped = Math.max(20, Math.min(80, pct));
      $('pane-editor').style.flex = `0 0 ${clamped}%`;
      $('pane-preview').style.flex = `0 0 ${100 - clamped}%`;
    });
    document.addEventListener('mouseup', () => { resizing = false; document.body.style.userSelect = ''; document.body.style.cursor = ''; });

    editor.addEventListener('dragover', e => { e.preventDefault(); editor.style.outline = '2px dashed var(--gold)'; });
    editor.addEventListener('dragleave', () => { editor.style.outline = ''; });
    editor.addEventListener('drop', e => {
      e.preventDefault();
      editor.style.outline = '';
      const f = e.dataTransfer.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = ev => { editor.value = ev.target.result; updateLineNumbers(); updatePreview(); toast(`Gliss√©-d√©pos√©: ${f.name}`); };
      r.readAsText(f);
    });

    restore();
    updateLineNumbers();
    updatePreview();
  </script>
</body>
</html>
